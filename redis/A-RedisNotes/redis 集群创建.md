# Redis 创建集群
redis 创建集群的方法有两种，第一种是通过官方提供的 redis-trib.rb 脚本自动创建集群。另一种是手动创建 redis 集群。

### 假设环境如下：
| 主节点  | 从节点  |
| :------------: | :------------: |
| 192.168.10.100:6379  | 192.168.10.100:6380  |
| 192.168.10.101:6379  | 192.168.10.101:6380  |
| 192.168.10.102:6379  | 192.168.10.102:6380  |


### 通过脚本自动创建集群
#### 安装 ruby
使用官方提供的脚本需要配置一定的环境，首先是要安装 redis 模块，要装 redis 模块，就要安装 2.2 以上的ruby，要装 2.2 以上的 ruby，就先需要装 ruby 的包管理器 rvm。so，我们还是先开始装 ruby 吧。
详细请看文档： [安装 ruby](http://76738810.wiz03.com/share/s/1SsUwg2MYh7E2ldXB13Y_86l3Ihfys06L4o22fCEYG0dWprG "安装 ruby")

#### 安装 redis 模块
安装好 2.2 以上的 ruby 之后，我们可以通过 gem 来安装 redis 模块。命令如下：
```
gem install redis
```

#### 创建集群
找到 redis-trib.rb 脚本存放目录并进入该目录。
敲一个命令创建集群：
```
./redis-trib.rb create --replicas 1  192.168.10.100:6379   192.168.10.100:6380
 192.168.10.101:6379   192.168.10.101:6380
 192.168.10.102:6379  192.168.10.102:6380
```

这样，集群就创建成功了。


### 手动创建集群
手动创建集群相对于自动创建集群来说，各有利弊，手动创建不用配置 ruby 环境，但是相对需要更多的繁琐的命令来建立集群。
#### 节点握手
找到任一机器上，并以此节点去与其他五个节点握手。以 192.168.10.100 的 6379 节点为例
```
./redis-cli -p 6379 -h 192.168.10.100 cluster meet 192.168.10.100 6380
./redis-cli -p 6379 -h 192.168.10.100 cluster meet 192.168.10.101 6379
./redis-cli -p 6379 -h 192.168.10.100 cluster meet 192.168.10.101 6380
./redis-cli -p 6379 -h 192.168.10.100 cluster meet 192.168.10.102 6379
./redis-cli -p 6379 -h 192.168.10.100 cluster meet 192.168.10.102 6380
```

查看握手是否顺利，命令如下：
```
./redis-cli -p 6379 -h 192.168.10.100 cluster nodes
```

若返回了六条结果回来，则说明握手顺利

或者查看集群信息，命令如下
```
./redis-cli -p 6379 -h 192.168.10.100 cluster info
```

#### 分配 slots
由于还没分配 slots，集群的状态还是处于 fail ，只有分配了 slots，集群的状态才是 ok。现在在三个主节点上分配 slots，命令如下：
```
./redis-cli -p 6379 -h 192.168.10.100 cluster addslots {0..5461}
./redis-cli -p 6379 -h 192.168.10.101 cluster addslots {5462..10922}
./redis-cli -p 6379 -h 192.168.10.103 cluster addslots {10923..16383}
```

分配完 slots 之后，再敲 cluster info 命令就可以发现，集群的状态变成 ok 了。但是这个还是不够的，我们还需要对集群进行主从复制。

#### 主从复制
redis 集群有高可用性，这个就体现在集群有三个主节点在工作，三个从节点作为备份。现在，我们要给三个主节点增加各自的备用的节点。命令如下：
```
# 通过 cluster nodes 查看各自的 node-id
./redis-cli -p 6379 -h 192.168.10.100 cluster nodes

# 192.168.10.100:6380 的 主节点是 192.168.10.100:6379
./redis-cli -p 6380 -h 192.168.10.100 cluster replicate ${192.168.10.100:6379-node-id}

# 192.168.10.101:6380 的 主节点是 192.168.10.101:6379
./redis-cli -p 6380 -h 192.168.10.101 cluster replicate ${192.168.10.101:6379-node-id}

# 192.168.10.102:6380 的 主节点是 192.168.10.102:6379
./redis-cli -p 6380 -h 192.168.10.102 cluster replicate ${192.168.10.102:6379-node-id}

```

至此，集群创建完成。
